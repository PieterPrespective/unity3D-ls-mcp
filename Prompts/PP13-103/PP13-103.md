# PP13-103: Phase 1 - ULSM Project Restructuring

## Assignment Overview

| Field | Value |
|-------|-------|
| **Issue ID** | PP13-103 |
| **Parent Issue** | PP13-102 |
| **Phase** | 1 of 5 |
| **Title** | Project Restructuring - Namespace Rename to ULSM |
| **Reference** | [DevRoadmap.md](../../Documentation/tdd/DevRoadmap.md) - Phase 1 |

---

## Objective

Transform the forked `dotnet-roslyn-mcp` project into the `ULSM` (Unity Language Server MCP) project by systematically renaming namespaces, files, and identifiers while maintaining full functionality of the existing codebase.

---

## Pre-Implementation Checklist

Before starting implementation, verify:

- [ ] Read and understand `Prompts/BasePrompt.md` for project conventions
- [ ] Read `Documentation/tdd/DevRoadmap.md` for full context
- [ ] Verify dev-diary branch is `ULSM-PWS` (not `main`)
- [ ] Verify knowledge-agent branch is `ULSM-PWS` (not `main`)
- [ ] Create registry entry for PP13-103 in dev diary
- [ ] Log implementation plan in dev diary
- [ ] Ensure `dotnet build` succeeds on current codebase before changes

---

## Implementation Tasks

### Task 1: File Renames

Rename the following files while preserving git history where possible:

| Current Path | New Path |
|--------------|----------|
| `src/RoslynMcp.csproj` | `src/ULSM.csproj` |
| `RoslynMcp.sln` | `ULSM.sln` |

**Implementation Steps:**

```bash
# 1. Rename solution file
git mv RoslynMcp.sln ULSM.sln

# 2. Rename project file
git mv src/RoslynMcp.csproj src/ULSM.csproj
```

**Post-Rename Validation:**
- Verify files exist at new locations
- Verify git tracks the rename (not delete + add)

---

### Task 2: Solution File Updates

**File:** `ULSM.sln`

Update project references within the solution file:

| Find | Replace |
|------|---------|
| `RoslynMcp.csproj` | `ULSM.csproj` |
| `"RoslynMcp"` | `"ULSM"` |

**Validation:**
- Solution file parses correctly
- `dotnet sln ULSM.sln list` shows correct project path

---

### Task 3: Project File Updates

**File:** `src/ULSM.csproj`

#### 3.1 Update PropertyGroup

Replace the existing PropertyGroup content with ULSM branding:

```xml
<PropertyGroup>
  <OutputType>Exe</OutputType>
  <TargetFramework>net8.0</TargetFramework>
  <ImplicitUsings>enable</ImplicitUsings>
  <Nullable>enable</Nullable>
  <LangVersion>latest</LangVersion>
  <RootNamespace>ULSM</RootNamespace>
  <AssemblyName>ULSM</AssemblyName>

  <!-- Global Tool Configuration -->
  <PackAsTool>true</PackAsTool>
  <ToolCommandName>ulsm</ToolCommandName>
  <PackageId>ulsm</PackageId>
  <Version>1.0.0</Version>
  <Authors>Prespective</Authors>
  <Description>Unity Language Server MCP - Roslyn-based code analysis for Unity 6.x projects via Model Context Protocol. Provides semantic analysis, diagnostics, refactoring, and Unity-specific pattern checking.</Description>
  <PackageTags>mcp;roslyn;unity;unity3d;csharp;code-analysis;language-server;claude-code;model-context-protocol</PackageTags>
  <RepositoryUrl>https://github.com/prespective/ulsm</RepositoryUrl>
  <PackageLicenseExpression>MIT</PackageLicenseExpression>
  <PackageReadmeFile>README.md</PackageReadmeFile>
</PropertyGroup>
```

#### 3.2 Update ItemGroup References

Ensure README path is correct:
```xml
<ItemGroup>
  <None Include="../README.md" Pack="true" PackagePath="/" />
  <None Include="server.json" CopyToOutputDirectory="PreserveNewest" Pack="true" PackagePath="contentFiles/any/net8.0/" />
</ItemGroup>
```

**Validation:**
- `dotnet restore src/ULSM.csproj` succeeds
- `dotnet build src/ULSM.csproj` succeeds

---

### Task 4: Namespace Renames in Source Files

#### 4.1 Program.cs

**File:** `src/Program.cs`

| Find | Replace |
|------|---------|
| `using RoslynMcp;` | `using ULSM;` |
| `namespace RoslynMcp` | `namespace ULSM` |

**Full expected content:**
```csharp
using Microsoft.Build.Locator;
using ULSM;

// Register MSBuild before any Roslyn code runs
MSBuildLocator.RegisterDefaults();

// Create and run the MCP server
var server = new McpServer();
await server.RunAsync();
```

#### 4.2 McpServer.cs

**File:** `src/McpServer.cs`

| Find | Replace |
|------|---------|
| `namespace RoslynMcp;` | `namespace ULSM;` |

**Update server info in `HandleInitializeAsync`:**
```csharp
serverInfo = new
{
    name = "ULSM - Unity Language Server MCP",
    version = "1.0.0"
}
```

#### 4.3 RoslynService.cs

**File:** `src/RoslynService.cs`

| Find | Replace |
|------|---------|
| `namespace RoslynMcp;` | `namespace ULSM;` |

**Note:** Keep the class name as `RoslynService` - it accurately describes the service's function. Only the namespace changes.

---

### Task 5: Tool Prefix Renames

**File:** `src/McpServer.cs`

Update all tool names from `roslyn:` prefix to `ulsm:` prefix.

#### 5.1 Tool Registration (HandleListToolsAsync)

Update every tool name in the tools list:

| Current | New |
|---------|-----|
| `roslyn:health_check` | `ulsm:health_check` |
| `roslyn:load_solution` | `ulsm:load_solution` |
| `roslyn:get_symbol_info` | `ulsm:get_symbol_info` |
| `roslyn:go_to_definition` | `ulsm:go_to_definition` |
| `roslyn:find_references` | `ulsm:find_references` |
| `roslyn:find_implementations` | `ulsm:find_implementations` |
| `roslyn:get_type_hierarchy` | `ulsm:get_type_hierarchy` |
| `roslyn:search_symbols` | `ulsm:search_symbols` |
| `roslyn:semantic_query` | `ulsm:semantic_query` |
| `roslyn:get_diagnostics` | `ulsm:get_diagnostics` |
| `roslyn:get_code_fixes` | `ulsm:get_code_fixes` |
| `roslyn:apply_code_fix` | `ulsm:apply_code_fix` |
| `roslyn:get_project_structure` | `ulsm:get_project_structure` |
| `roslyn:organize_usings` | `ulsm:organize_usings` |
| `roslyn:organize_usings_batch` | `ulsm:organize_usings_batch` |
| `roslyn:format_document_batch` | `ulsm:format_document_batch` |
| `roslyn:get_method_overloads` | `ulsm:get_method_overloads` |
| `roslyn:get_containing_member` | `ulsm:get_containing_member` |
| `roslyn:find_callers` | `ulsm:find_callers` |
| `roslyn:find_unused_code` | `ulsm:find_unused_code` |
| `roslyn:rename_symbol` | `ulsm:rename_symbol` |
| `roslyn:extract_interface` | `ulsm:extract_interface` |
| `roslyn:dependency_graph` | `ulsm:dependency_graph` |

#### 5.2 Tool Dispatch (HandleToolCallAsync)

Update the switch statement that dispatches tool calls:

```csharp
var result = name switch
{
    "ulsm:health_check" => await _roslynService.GetHealthCheckAsync(),
    "ulsm:load_solution" => await _roslynService.LoadSolutionAsync(...),
    // ... all other tools
    _ => throw new Exception($"Unknown tool: {name}")
};
```

**Systematic Approach:**
1. Use find-and-replace with `"roslyn:` → `"ulsm:`
2. Verify count of replacements matches expected (approximately 46 occurrences: 23 tools × 2 locations)

---

### Task 6: Server.json Updates

**File:** `src/server.json`

Update the server configuration file with ULSM branding:

```json
{
  "name": "ulsm",
  "displayName": "ULSM - Unity Language Server MCP",
  "description": "Roslyn-based code analysis for Unity 6.x projects via Model Context Protocol",
  "version": "1.0.0",
  "author": "Prespective",
  "license": "MIT",
  "repository": "https://github.com/prespective/ulsm",
  "tools": {
    "prefix": "ulsm",
    "categories": [
      {
        "name": "Navigation",
        "tools": ["health_check", "load_solution", "get_symbol_info", "go_to_definition", "find_references", "find_implementations", "get_type_hierarchy"]
      },
      {
        "name": "Search",
        "tools": ["search_symbols", "semantic_query"]
      },
      {
        "name": "Diagnostics",
        "tools": ["get_diagnostics", "get_code_fixes", "apply_code_fix"]
      },
      {
        "name": "Structure",
        "tools": ["get_project_structure", "get_method_overloads", "get_containing_member", "dependency_graph"]
      },
      {
        "name": "Refactoring",
        "tools": ["organize_usings", "organize_usings_batch", "format_document_batch", "rename_symbol", "extract_interface"]
      },
      {
        "name": "Analysis",
        "tools": ["find_callers", "find_unused_code"]
      }
    ]
  },
  "environment": {
    "DOTNET_SOLUTION_PATH": {
      "description": "Path to .sln file to auto-load on startup",
      "required": false
    },
    "ULSM_LOG_LEVEL": {
      "description": "Log level: Debug, Information, Warning, Error",
      "default": "Information"
    },
    "ULSM_MAX_DIAGNOSTICS": {
      "description": "Maximum diagnostics to return per request",
      "default": "100"
    },
    "ULSM_TIMEOUT_SECONDS": {
      "description": "Timeout for analysis operations",
      "default": "30"
    }
  }
}
```

---

### Task 7: Environment Variable Renames

**File:** `src/RoslynService.cs`

Update environment variable names to use ULSM prefix:

| Current | New |
|---------|-----|
| `ROSLYN_MAX_DIAGNOSTICS` | `ULSM_MAX_DIAGNOSTICS` |
| `ROSLYN_TIMEOUT_SECONDS` | `ULSM_TIMEOUT_SECONDS` |
| `ROSLYN_ENABLE_SEMANTIC_CACHE` | `ULSM_ENABLE_SEMANTIC_CACHE` |

**File:** `src/McpServer.cs`

| Current | New |
|---------|-----|
| `ROSLYN_LOG_LEVEL` | `ULSM_LOG_LEVEL` |

**Note:** Keep `DOTNET_SOLUTION_PATH` unchanged - it's a standard .NET convention.

---

### Task 8: Log Message Updates

Update log messages throughout the codebase to use ULSM branding:

**File:** `src/McpServer.cs`

| Find | Replace |
|------|---------|
| `"Roslyn MCP Server starting..."` | `"ULSM (Unity Language Server MCP) starting..."` |
| `"[Warning] Workspace:"` | `"[ULSM Warning] Workspace:"` |

**File:** `src/RoslynService.cs`

| Find | Replace |
|------|---------|
| `"[Warning] Workspace:"` | `"[ULSM Warning] Workspace:"` |

---

### Task 9: Health Check Response Updates

**File:** `src/RoslynService.cs` - `GetHealthCheckAsync` method

Update the health check response to reflect ULSM branding:

```csharp
return new
{
    status = "Not Ready",
    message = "No solution loaded. Call ulsm:load_solution first or set DOTNET_SOLUTION_PATH environment variable.",
    // ...
};

// And for ready state:
return new
{
    status = "Ready",
    message = "ULSM (Unity Language Server MCP) is operational",
    // ...
};
```

---

## Validation Checklist

After completing all tasks, verify:

### Build Validation
```bash
# Clean and rebuild
dotnet clean ULSM.sln
dotnet restore ULSM.sln
dotnet build ULSM.sln

# Verify no build errors
# Verify no build warnings related to namespace/references
```

### Runtime Validation
```bash
# Run the server
dotnet run --project src/ULSM.csproj

# Verify startup message shows ULSM branding
# Expected: "[HH:mm:ss] [Information] ULSM (Unity Language Server MCP) starting..."
```

### Tool Validation

Send test MCP requests to verify tools respond:

```json
{"jsonrpc":"2.0","id":1,"method":"initialize","params":{}}
```
Expected: Server info shows `"name": "ULSM - Unity Language Server MCP"`

```json
{"jsonrpc":"2.0","id":2,"method":"tools/list","params":{}}
```
Expected: All tools have `ulsm:` prefix

```json
{"jsonrpc":"2.0","id":3,"method":"tools/call","params":{"name":"ulsm:health_check","arguments":{}}}
```
Expected: Health check returns ULSM-branded message

### Code Quality Validation
```bash
# Search for any remaining "roslyn" references (case-insensitive)
# Should only find:
# - Microsoft.CodeAnalysis.* namespace references (expected)
# - RoslynService class name (intentionally kept)
# - Comments/documentation referencing Roslyn technology
```

---

## File Change Summary

| File | Changes |
|------|---------|
| `ULSM.sln` (renamed) | Project reference paths |
| `src/ULSM.csproj` (renamed) | PropertyGroup metadata, RootNamespace, AssemblyName |
| `src/Program.cs` | Namespace import |
| `src/McpServer.cs` | Namespace, tool names (×46), server info, log messages |
| `src/RoslynService.cs` | Namespace, environment variables, health check messages |
| `src/server.json` | Complete rewrite for ULSM branding |

---

## Git Commit Strategy

### Commit 1: File Renames
```bash
git add -A
git commit -m "PP13-103: Rename project files from RoslynMcp to ULSM

- Rename RoslynMcp.sln → ULSM.sln
- Rename src/RoslynMcp.csproj → src/ULSM.csproj
- Update solution project references"
```

### Commit 2: Namespace and Branding Updates
```bash
git add -A
git commit -m "PP13-103: Update namespaces and branding to ULSM

- Change namespace from RoslynMcp to ULSM in all source files
- Update tool prefix from roslyn: to ulsm:
- Update server info and health check messages
- Rename environment variables to ULSM_* prefix
- Update server.json with ULSM configuration"
```

---

## Dev Diary Logging

### At Start
```
/devdiary ASSIGNMENT: Create Diary Entry
issue_id: PP13-103
entry_type: plan
content: Starting Phase 1 implementation - Project restructuring from RoslynMcp to ULSM. Tasks: file renames, namespace updates, tool prefix changes, environment variable renames, branding updates.
```

### During Implementation (at each major milestone)
```
/devdiary ASSIGNMENT: Create Diary Entry
issue_id: PP13-103
entry_type: work
content: [Description of completed work]
```

### On Completion
```
/devdiary ASSIGNMENT: Create Diary Entry
issue_id: PP13-103
entry_type: work
content: Phase 1 complete. All files renamed, namespaces updated, tool prefixes changed to ulsm:*. Build validates successfully. Ready for Phase 2.
```

### If Issues Encountered
```
/devdiary ASSIGNMENT: Create Diary Entry
issue_id: PP13-103
entry_type: challenge
content: [Description of challenge and resolution]
```

---

## Rollback Procedure

If implementation fails and rollback is needed:

```bash
# Option 1: Git reset (if not pushed)
git reset --hard HEAD~2  # Undo last 2 commits

# Option 2: Git revert (if pushed)
git revert HEAD~1..HEAD

# Option 3: Restore from backup
# (Ensure backup was created before starting)
```

---

## Success Criteria

Phase 1 is complete when:

1. ✅ All files renamed from RoslynMcp to ULSM
2. ✅ All namespaces changed to ULSM
3. ✅ All tool prefixes changed from `roslyn:` to `ulsm:`
4. ✅ All environment variables use `ULSM_` prefix
5. ✅ Server identifies as "ULSM - Unity Language Server MCP"
6. ✅ `dotnet build ULSM.sln` succeeds with no errors
7. ✅ `dotnet run --project src/ULSM.csproj` starts successfully
8. ✅ MCP initialize returns correct server info
9. ✅ tools/list returns all tools with `ulsm:` prefix
10. ✅ `ulsm:health_check` returns ULSM-branded response

---

## Next Phase

After completing PP13-103, proceed to:
- **PP13-104: Phase 2 - Unity Workspace Loader** (see DevRoadmap.md)
