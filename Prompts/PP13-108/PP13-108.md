# PP13-108: Fix Solution Path and Health Check State Management

## Assignment Overview

| Field | Value |
|-------|-------|
| **Issue ID** | PP13-108 |
| **Parent Issue** | PP13-102 |
| **Depends On** | PP13-107 (Phase 5 - Documentation) |
| **Priority** | High (Bug Fix) |
| **Title** | Fix DOTNET_SOLUTION_PATH Auto-Load and Health Check State Tracking |
| **Reference** | [260204_ULSMSolutionPathIssue.md](../../Examples/260204_ULSMSolutionPathIssue.md) |
| **Affected Version** | v1.0.0, v1.0.1 |

---

## Objective

Fix critical state management bugs in ULSM that cause:
1. `DOTNET_SOLUTION_PATH` environment variable to be silently ignored
2. `ulsm_health_check` to report "Not Ready" even after successful solution load
3. `solutionPath: null` in load_solution response despite successful load

These issues severely impact user experience as the server appears broken even when functioning correctly.

---

## Root Cause Analysis

### Issue 1: DOTNET_SOLUTION_PATH Not Auto-Loading

**Location:** `src/McpServer.cs` lines 28-54

**Root Cause:** Silent failures in auto-load logic:

```csharp
// Current problematic code
var solutionPath = Environment.GetEnvironmentVariable("DOTNET_SOLUTION_PATH");
if (!string.IsNullOrEmpty(solutionPath))
{
    try
    {
        if (Directory.Exists(solutionPath))
        {
            var slnFiles = Directory.GetFiles(solutionPath, "*.sln");
            if (slnFiles.Length > 0)
            {
                solutionPath = slnFiles[0];
            }
        }

        if (File.Exists(solutionPath))  // <-- Silent failure if false
        {
            await LogAsync("Information", $"Auto-loading solution: {solutionPath}");
            await _roslynService.LoadSolutionAsync(solutionPath);
        }
        // NO LOG when File.Exists returns false!
    }
    catch (Exception ex)
    {
        await LogAsync("Warning", $"Failed to auto-load solution: {ex.Message}");
    }
}
```

**Problems:**
1. When `File.Exists(solutionPath)` returns false after processing, nothing is logged
2. Relative paths like `./Omron_ONT/Omron_ONT.sln` resolve against the *process* working directory, not the MCP client's workspace
3. No feedback mechanism to inform the user why auto-load failed
4. Path may be a directory but contain no `.sln` files (silent failure)

---

### Issue 2: Health Check Reports "Not Ready" After Successful Load

**Location:** `src/RoslynService.cs` lines 104-113 and 146-157

**Root Cause:** When AdhocWorkspace fallback is used, workspace is stored in wrong field:

```csharp
// Line 104-113: Workspace storage logic
if (workspace is MSBuildWorkspace msbuildWorkspace)
{
    _workspace = msbuildWorkspace;  // MSBuildWorkspace → _workspace
}
else
{
    _workspaceBase = workspace;     // AdhocWorkspace → _workspaceBase (NOT _workspace!)
}

_solution = solution;  // Solution is always set correctly
```

```csharp
// Line 146-157: Health check logic
if (_solution == null || _workspace == null)  // <-- BUG: _workspace is null for AdhocWorkspace!
{
    return new
    {
        status = "Not Ready",
        message = "No solution loaded...",
        ...
    };
}
```

**Result:** When Unity projects use AdhocWorkspace fallback:
- `_solution` is set correctly ✓
- `_workspace` remains null (AdhocWorkspace is in `_workspaceBase`) ✗
- Health check sees `_workspace == null` and reports "Not Ready" ✗

---

### Issue 3: `solutionPath: null` in Response

**Location:** `src/RoslynService.cs` line 136

**Root Cause:** AdhocWorkspace solutions don't have FilePath set:

```csharp
// Line 133-143: Load response
return new
{
    success = true,
    solutionPath = _solution.FilePath,  // <-- null for AdhocWorkspace solutions!
    projectCount,
    ...
};
```

**Why it's null:**
- `UnityAdhocWorkspaceBuilder.BuildFromSolutionAsync()` creates a new AdhocWorkspace
- `workspace.CurrentSolution` is returned, but `FilePath` is never set on it
- The original `solutionPath` parameter is not propagated to the response

---

### Issue 4: usedFallback: true (Not a Bug)

**Status:** Working as designed

The fallback mechanism correctly:
1. Tries MSBuildWorkspace first
2. Falls back to AdhocWorkspace when MSBuild fails
3. Returns `usedFallback: true` to indicate fallback was used

However, the health check doesn't account for fallback mode, causing confusion.

---

## Implementation Tasks

### Task 1: Fix Auto-Load Path Resolution and Logging

**File:** `src/McpServer.cs`

**Changes:**

1. **Add verbose logging for path resolution:**
```csharp
var solutionPath = Environment.GetEnvironmentVariable("DOTNET_SOLUTION_PATH");
if (!string.IsNullOrEmpty(solutionPath))
{
    var originalPath = solutionPath;
    await LogAsync("Information", $"DOTNET_SOLUTION_PATH set to: {solutionPath}");

    try
    {
        // Resolve relative paths against current directory
        if (!Path.IsPathRooted(solutionPath))
        {
            var currentDir = Environment.CurrentDirectory;
            solutionPath = Path.GetFullPath(Path.Combine(currentDir, solutionPath));
            await LogAsync("Information", $"Resolved relative path to: {solutionPath}");
        }

        // If it's a directory, try to find a .sln file
        if (Directory.Exists(solutionPath))
        {
            var slnFiles = Directory.GetFiles(solutionPath, "*.sln");
            if (slnFiles.Length > 0)
            {
                solutionPath = slnFiles[0];
                await LogAsync("Information", $"Found solution in directory: {solutionPath}");
            }
            else
            {
                await LogAsync("Warning", $"Directory exists but contains no .sln files: {solutionPath}");
            }
        }

        if (File.Exists(solutionPath))
        {
            await LogAsync("Information", $"Auto-loading solution: {solutionPath}");
            await _roslynService.LoadSolutionAsync(solutionPath);
            await LogAsync("Information", "Solution auto-loaded successfully");
        }
        else
        {
            await LogAsync("Warning", $"Solution file not found: {solutionPath}");
            await LogAsync("Warning", $"Original DOTNET_SOLUTION_PATH was: {originalPath}");
            await LogAsync("Warning", $"Current working directory: {Environment.CurrentDirectory}");
        }
    }
    catch (Exception ex)
    {
        await LogAsync("Warning", $"Failed to auto-load solution: {ex.Message}");
    }
}
else
{
    await LogAsync("Information", "DOTNET_SOLUTION_PATH not set, waiting for ulsm:load_solution call");
}
```

2. **Store auto-load error state for health check reporting:**

Add field to McpServer.cs:
```csharp
private string? _autoLoadError;
```

Update error handling to set this field, then pass to RoslynService or expose via health check.

---

### Task 2: Fix Health Check State Validation

**File:** `src/RoslynService.cs`

**Changes:**

1. **Fix the health check condition (line 148):**

Change from:
```csharp
if (_solution == null || _workspace == null)
```

To:
```csharp
if (_solution == null)
```

The presence of `_solution` is sufficient to indicate a loaded workspace. The workspace type (MSBuildWorkspace vs AdhocWorkspace) is irrelevant for determining ready state.

2. **Add workspace type information to health check response:**

```csharp
public async Task<object> GetHealthCheckAsync()
{
    if (_solution == null)
    {
        return new
        {
            status = "Not Ready",
            message = "No solution loaded. Call ulsm:load_solution first or set DOTNET_SOLUTION_PATH environment variable.",
            solution = (object?)null,
            workspace = (object?)null
        };
    }

    // Determine workspace type
    var workspaceType = _workspace != null ? "MSBuildWorkspace" :
                        _workspaceBase != null ? "AdhocWorkspace" : "Unknown";

    // ... rest of health check logic ...

    return new
    {
        status = "Ready",
        message = "ULSM (Unity Language Server MCP) is operational",
        solution = new
        {
            loaded = true,
            path = _solutionPath ?? _solution.FilePath,  // Use stored path
            projects = projectCount,
            documents = documentCount,
            loadedAt = _solutionLoadedAt?.ToString("yyyy-MM-ddTHH:mm:ssZ"),
            errors = errorCount,
            warnings = warningCount,
            isUnityProject = _isUnityProject,
            unityVersion = _unityVersion,
            usedFallback = _usedFallbackWorkspace
        },
        workspace = new
        {
            type = workspaceType,
            // ... other workspace info
        }
    };
}
```

---

### Task 3: Fix solutionPath in Load Response

**File:** `src/RoslynService.cs`

**Changes:**

1. **Add field to store original solution path:**

```csharp
private string? _solutionPath;  // Store the original path passed to LoadSolutionAsync
```

2. **Store path in LoadSolutionAsync:**

```csharp
public async Task<object> LoadSolutionAsync(string solutionPath)
{
    _solutionPath = solutionPath;  // Store original path
    // ... existing logic ...
}
```

3. **Use stored path in response (line 136):**

Change from:
```csharp
solutionPath = _solution.FilePath,
```

To:
```csharp
solutionPath = _solutionPath ?? _solution.FilePath,
```

---

### Task 4: Update UnityAdhocWorkspaceBuilder

**File:** `src/Unity/UnityAdhocWorkspaceBuilder.cs`

**Changes:**

Consider setting the solution FilePath in the AdhocWorkspace:

```csharp
public static async Task<(AdhocWorkspace workspace, Solution solution)> BuildFromSolutionAsync(string solutionPath)
{
    var workspace = new AdhocWorkspace();

    // ... project building logic ...

    // Set solution file path
    var solutionId = SolutionId.CreateNewId();
    var solutionInfo = SolutionInfo.Create(
        solutionId,
        VersionStamp.Default,
        solutionPath,  // Pass the solution file path
        projects: projectInfos);

    workspace.AddSolution(solutionInfo);

    return (workspace, workspace.CurrentSolution);
}
```

Note: Verify if AdhocWorkspace supports setting FilePath this way; if not, the fallback to `_solutionPath` in Task 3 handles it.

---

### Task 5: Add Integration Tests

**File:** `tests/ULSM.Tests/Integration/SolutionLoadingTests.cs`

```csharp
[TestFixture]
public class SolutionLoadingTests
{
    [Test]
    public async Task HealthCheck_AfterAdhocWorkspaceLoad_ReturnsReady()
    {
        // Arrange
        var service = new RoslynService();

        // Act - Force adhoc workspace
        Environment.SetEnvironmentVariable("ULSM_FORCE_ADHOC", "true");
        try
        {
            await service.LoadSolutionAsync(TestPaths.UnityTestProjectSolution);
            var health = await service.GetHealthCheckAsync();

            // Assert
            dynamic result = health;
            Assert.That(result.status, Is.EqualTo("Ready"));
            Assert.That(result.solution.usedFallback, Is.True);
        }
        finally
        {
            Environment.SetEnvironmentVariable("ULSM_FORCE_ADHOC", null);
        }
    }

    [Test]
    public async Task LoadSolution_ReturnsCorrectPath()
    {
        // Arrange
        var service = new RoslynService();
        var expectedPath = TestPaths.UnityTestProjectSolution;

        // Act
        dynamic result = await service.LoadSolutionAsync(expectedPath);

        // Assert
        Assert.That(result.success, Is.True);
        Assert.That(result.solutionPath, Is.EqualTo(expectedPath));
    }
}
```

---

## Validation Checklist

### Functional Tests

- [ ] Relative path `./Omron_ONT/Omron_ONT.sln` resolves correctly (or logs meaningful error)
- [ ] Absolute path `D:/path/to/solution.sln` auto-loads correctly
- [ ] Health check returns "Ready" after successful AdhocWorkspace load
- [ ] Health check returns "Ready" after successful MSBuildWorkspace load
- [ ] `solutionPath` in load_solution response matches the input path
- [ ] Auto-load failures produce meaningful log messages

### Build Validation

- [ ] `dotnet build ULSM.sln` succeeds
- [ ] `dotnet test ULSM.sln` all tests pass
- [ ] No new warnings introduced

---

## Git Commit Strategy

### Commit 1: Fix health check state validation

```bash
git add src/RoslynService.cs
git commit -m "fix(health): check only _solution for ready state

The health check was checking _workspace != null, but when
AdhocWorkspace fallback is used, the workspace is stored in
_workspaceBase instead. Changed condition to only check _solution
since that's the reliable indicator of a loaded workspace.

Fixes: Health check reporting 'Not Ready' after successful load
Refs: PP13-108"
```

### Commit 2: Fix solutionPath in response

```bash
git add src/RoslynService.cs
git commit -m "fix(load): return original solutionPath in response

AdhocWorkspace solutions don't have FilePath set, causing
solutionPath: null in responses. Now storing and returning
the original path passed to LoadSolutionAsync.

Fixes: solutionPath: null in load_solution response
Refs: PP13-108"
```

### Commit 3: Improve auto-load path resolution and logging

```bash
git add src/McpServer.cs
git commit -m "fix(autoload): improve path resolution and error logging

- Log DOTNET_SOLUTION_PATH value at startup
- Resolve relative paths against current directory
- Log meaningful errors when path resolution fails
- Report working directory for debugging

Fixes: DOTNET_SOLUTION_PATH silently ignored
Refs: PP13-108"
```

### Commit 4: Add integration tests

```bash
git add tests/ULSM.Tests/Integration/SolutionLoadingTests.cs
git commit -m "test(load): add solution loading integration tests

- Test health check after AdhocWorkspace load
- Test solutionPath in load response
- Test relative path resolution

Refs: PP13-108"
```

---

## Dev Diary Logging

### At Start

```
/devdiary ASSIGNMENT: Create Registry Entry
issue_id: PP13-108
title: Fix Solution Path and Health Check State Management
summary: Critical bug fix for DOTNET_SOLUTION_PATH auto-load failures and health check reporting "Not Ready" after successful AdhocWorkspace loads. Root causes identified: (1) Silent path resolution failures, (2) Health check validates _workspace which is null for AdhocWorkspace, (3) solutionPath not stored for response.
related_issues: PP13-102,PP13-104,PP13-107
```

```
/devdiary ASSIGNMENT: Create Diary Entry
issue_id: PP13-108
entry_type: plan
content: Starting PP13-108 implementation. Root cause analysis complete. Four tasks: (1) Fix auto-load path resolution and logging in McpServer.cs, (2) Fix health check condition in RoslynService.cs to only check _solution, (3) Store and return original solutionPath in load response, (4) Add integration tests for solution loading. Estimated: 4 commits.
```

### On Completion

```
/devdiary ASSIGNMENT: Create Diary Entry
issue_id: PP13-108
entry_type: work
content: PP13-108 complete. Fixed health check state validation (check _solution only, not _workspace), fixed solutionPath response (store original path), improved auto-load logging (verbose path resolution debugging). All tests pass. Ready for v1.0.2 release.
```

---

## Success Criteria

- [ ] `DOTNET_SOLUTION_PATH` with relative path logs meaningful debug info
- [ ] `DOTNET_SOLUTION_PATH` with absolute path auto-loads solution
- [ ] `ulsm_health_check` returns "Ready" after successful load (any workspace type)
- [ ] `ulsm_load_solution` response includes correct `solutionPath`
- [ ] `usedFallback: true` correctly indicates AdhocWorkspace was used
- [ ] All existing tests pass
- [ ] New integration tests pass

---

## Appendix A: Affected Files Summary

| File | Changes |
|------|---------|
| `src/McpServer.cs` | Improve auto-load logging and path resolution |
| `src/RoslynService.cs` | Fix health check condition, store solutionPath |
| `src/Unity/UnityAdhocWorkspaceBuilder.cs` | (Optional) Set solution FilePath |
| `tests/ULSM.Tests/Integration/SolutionLoadingTests.cs` | New test file |

## Appendix B: Test Verification Commands

```bash
# After fix, verify with manual test
cd "D:\Prespective\GIT\git-omron_1-2020\Omron-1-OLD"
set DOTNET_SOLUTION_PATH=./Omron_ONT/Omron_ONT.sln
dotnet ulsm 2>&1 | head -20

# Expect to see:
# [ULSM] DOTNET_SOLUTION_PATH set to: ./Omron_ONT/Omron_ONT.sln
# [ULSM] Resolved relative path to: D:\Prespective\GIT\...\Omron_ONT.sln
# [ULSM] Auto-loading solution: ...
# OR meaningful error message if path invalid
```
